[gd_scene load_steps=17 format=3 uid="uid://bixm1xmwh4h83"]

[ext_resource type="Theme" uid="uid://dmce53ilrrlem" path="res://main-theme.tres" id="2_665qb"]
[ext_resource type="Script" path="res://scripts/GameState.gd" id="3_6rb05"]
[ext_resource type="PackedScene" uid="uid://dj4cqaqhhkqus" path="res://scenes/game_starting_ui.tscn" id="3_ricfi"]
[ext_resource type="PackedScene" uid="uid://6folc8h7iqa7" path="res://scenes/game_over_screen.tscn" id="4_47ygy"]

[sub_resource type="GDScript" id="GDScript_vuba5"]
resource_name = "drawer"
script/source = "extends Node2D

@onready
var _game_state : GameState = %GameState 

func _ready() -> void:
	get_tree().root.size_changed.connect(_on_viewport_size_changed)
	_on_viewport_size_changed()


func _process(delta: float) -> void:
	queue_redraw()


func _draw() -> void:
	draw_rect(Rect2(Vector2.ZERO, _game_state.playing_area_size), _game_state.playing_area_rect_color, false)
	
	draw_line(Vector2(0, _game_state.blocks_deadline_height), 
		Vector2(_game_state.playing_area_size.x, _game_state.blocks_deadline_height), 
		_game_state.deadline_color, _game_state.block_draw_width, true)
	
	draw_circle(_game_state.ball_position, 
		_game_state.ball_radius-_game_state.ball_draw_width/2.0, 
		_game_state.ball_color, false, _game_state.ball_draw_width, true)
	
	draw_rect(_game_state.platform_rect.rect.grow(-_game_state.platform_draw_width/2.0), 
	_game_state.platform_color, false, _game_state.platform_draw_width, false
	)
	
	for block:ArcanoidBlock in _game_state.blocks:
		draw_rect(block.rect.grow(-_game_state.block_draw_width/2.0), 
		_game_state.blocks_colors[min(block.hp-1, len(_game_state.blocks_colors))], false, _game_state.block_draw_width, false
		)

func set_window_scale(scale_factor:float) -> void:
	var diff : Vector2 = _game_state.playing_area_size - \\
		_game_state.playing_area_size*scale_factor
	
	position += diff/2
	scale = Vector2(scale_factor, scale_factor)


func _on_viewport_size_changed() -> void:
	var old_scale_factor : float = scale.x
	set_window_scale(1.0)
	var viewport_center : Vector2 = get_tree().root.size / 2
	var playing_area_center : Vector2 = position + _game_state.playing_area_size / 2.0
	
	var diff : Vector2 = viewport_center - playing_area_center
	position += diff
	set_window_scale(old_scale_factor)
"

[sub_resource type="GDScript" id="GDScript_ypwq7"]
resource_name = "game_controller"
script/source = "extends Node

@onready
var _game_state : GameState = %GameState

const DAMAGE_TIME_AWATING : float = 1.0 # sec

enum BallCollisionTypes {
	BORDER,
	PLATFORM,
	BLOCK
}

enum DamageReasons {
	BALL_FALLED,
	DEADLINE_REACHED,
}

var chosen_ability : Ability

var _damage_reason : DamageReasons

func _ready() -> void:
	_game_state.state_machine.handle_state(GameState.GAME_STARTING_STATE, _on_state_game_starting)
	_game_state.state_machine.handle_state(GameState.LAUNCHING_BALL_STATE, _on_state_launching_ball)
	_game_state.state_machine.handle_state(GameState.CONTROLLING_BALL_STATE, _on_state_controlling_ball)
	_game_state.state_machine.handle_state(GameState.WAITING_FOR_DAMAGE_STATE, _on_state_waiting_for_damage)
	_game_state.state_machine.handle_state(GameState.GAME_OVER_STATE, _on_state_game_over)
	
	_game_state.state_machine.state = GameState.GAME_STARTING_STATE


func _on_state_game_starting() -> void:
	_game_state.platform_rect.rect.position = Vector2(
		_game_state.playing_area_size.x/2.0 -_game_state.platform_rect.rect.size.x/2.0, 
		_game_state.playing_area_size.y-_game_state.platform_height-_game_state.platform_rect.rect.size.y)
	_place_ball_to_launch_position()
	for i:int in _game_state.initial_block_rows:
		_spawn_blocks_layer()


func _on_state_launching_ball() -> void:
	chosen_ability.deactivate()
	_place_ball_to_launch_position()


func _on_state_controlling_ball() -> void:
	pass


func _on_state_waiting_for_damage() -> void:
	var old_color : Color = _game_state.playing_area_rect_color
	var tween := create_tween()
	tween.tween_property(_game_state, \"playing_area_rect_color\", 
		Color.RED, DAMAGE_TIME_AWATING*0.2)
	tween.chain().tween_property(_game_state, \"playing_area_rect_color\",
		old_color, DAMAGE_TIME_AWATING*0.8)


func _on_state_game_over() -> void:
	pass


func _process(delta: float) -> void:
	match _game_state.state_machine.state:
		GameState.GAME_STARTING_STATE:
			_process_game_starting(delta)
		GameState.LAUNCHING_BALL_STATE:
			_process_launching_ball(delta)
		GameState.CONTROLLING_BALL_STATE:
			_process_controlling_ball(delta)


func _process_game_starting(delta:float) -> void:
	pass


func _process_launching_ball(delta:float) -> void:
	var ball_relative_position : Vector2 = _game_state.ball_position - _game_state.platform_rect.rect.position
	_handle_platform_movement(delta)
	_game_state.ball_position = _game_state.platform_rect.rect.position + ball_relative_position
	
	if Input.is_action_just_pressed(\"platform_launch_ball\"):
		var launch_direction : Vector2 = (_game_state.ball_position - _game_state.platform_rect.rect.get_center()).normalized()
		_game_state.ball_velocity = launch_direction*_game_state.ball_velocity.length()
		_game_state.state_machine.go_state(GameState.CONTROLLING_BALL_STATE)


func _process_controlling_ball(delta:float) -> void:
	const PLATFORM_HEIGHT : float = 20.0
	
	_handle_platform_movement(delta)
	
	if Input.is_action_just_pressed(\"platform_launch_ball\"):
		if chosen_ability != null:
			chosen_ability.activate()
	
	if Input.is_action_just_released(\"platform_launch_ball\"):
		if chosen_ability != null:
				chosen_ability.deactivate()
	
	_check_collisions(delta)



func _check_collisions(delta:float) -> void:
	var playing_area_limiter_rect := _game_state.playing_area_ball_collide_rect
	var platform_rect := _game_state.platform_rect
	
	var old_ball_position : Vector2 = _game_state.ball_position
	var old_ball_velocity : Vector2 = _game_state.ball_velocity
	
	var frametime : float = 0.0
	var banned_rects_sides := ArcanoidGeometry.RectGroupBannedSides.new()
	while true:
		var collisions_rects : Array[ArcanoidRect] = [];
		collisions_rects.append_array(_game_state.blocks.duplicate())
		collisions_rects.append_array([playing_area_limiter_rect, platform_rect])
		
		var earliest_collision := ArcanoidGeometry.ccd_circle_box_group(
				_game_state.ball_position, _game_state.ball_position+_game_state.ball_velocity*delta,
				 _game_state.ball_radius,
				collisions_rects, banned_rects_sides)
		
		if earliest_collision == null:
			_game_state.ball_position += _game_state.ball_velocity*delta*(1.0-frametime)
			break
		
		_game_state.ball_position += _game_state.ball_velocity*delta*earliest_collision.collision_time
		frametime += earliest_collision.collision_time
		
		if earliest_collision.collision_rect == playing_area_limiter_rect:
			if earliest_collision.collided_rect_side == SIDE_BOTTOM:
				_on_ball_falled()
				return
			
			if (earliest_collision.collided_rect_side == SIDE_TOP or earliest_collision.collided_rect_side == SIDE_BOTTOM):
				_game_state.ball_velocity.y *= -1
			else:
				_game_state.ball_velocity.x *= -1
			banned_rects_sides = ArcanoidGeometry.RectGroupBannedSides.new()
			banned_rects_sides.ban_side(earliest_collision.collision_rect, earliest_collision.collided_rect_side)
		
		elif earliest_collision.collision_rect == platform_rect:
			_game_state.ball_velocity = (_game_state.ball_position-_game_state.platform_rect.rect.get_center()-Vector2(0, 20)).normalized() * _game_state.ball_velocity.length()
			_game_state.ball_position.y = _game_state.platform_rect.rect.position.y-_game_state.ball_radius-2.0
			_on_ball_platform_collision.call_deferred()
			banned_rects_sides = ArcanoidGeometry.RectGroupBannedSides.new()
			banned_rects_sides.ban_side(earliest_collision.collision_rect, earliest_collision.collided_rect_side)
			
		else: # block collide
			if (earliest_collision.collision_rect as ArcanoidBlock).hp <= 1:
				_game_state.blocks.erase(earliest_collision.collision_rect)
			else:
				(earliest_collision.collision_rect as ArcanoidBlock).hp -= 1
			if (earliest_collision.collided_rect_side == SIDE_TOP or earliest_collision.collided_rect_side == SIDE_BOTTOM):
				_game_state.ball_velocity.y *= -1
			else:
				_game_state.ball_velocity.x *= -1
			_game_state.score += 1
			banned_rects_sides = ArcanoidGeometry.RectGroupBannedSides.new()
			banned_rects_sides.ban_side(earliest_collision.collision_rect, earliest_collision.collided_rect_side)
	
	# hardcoded bugfix, when ball super rarely just ignore walls
	if not Rect2(Vector2.ZERO, _game_state.playing_area_size).grow(-_game_state.ball_radius).has_point(_game_state.ball_position):
		if _game_state.ball_position.x <= 0.0:
			_game_state.ball_position.x = 0.0 + _game_state.ball_radius + 4.0
			_game_state.ball_velocity.x *= -1
		elif  _game_state.ball_position.x >= _game_state.playing_area_size.x:
			_game_state.ball_position.x = _game_state.playing_area_size.x - _game_state.ball_radius - 4.0
			_game_state.ball_velocity.x *= -1
		
		if _game_state.ball_position.y <= 0.0:
			_game_state.ball_velocity.y *= -1
			_game_state.ball_position.y = 0.0 + _game_state.ball_radius + 4.0
		elif _game_state.ball_position.y >= _game_state.playing_area_size.y:
			_on_ball_falled()
		print(\"TRUTEN\")


func _place_ball_to_launch_position() -> void:
	const BALL_PLATFORM_GAP : float = 2.0
	
	_game_state.ball_position = _game_state.platform_rect.rect.position + \\
		Vector2(_game_state.platform_rect.rect.size.x*randf(), -_game_state.ball_radius-BALL_PLATFORM_GAP)


func _handle_platform_movement(delta:float) -> void:
	var platform_speed_input : float = Input.get_axis(\"platform_left\", \"platform_right\")
	
	_game_state.platform_rect.rect.position.x += _game_state.platform_speed*delta*platform_speed_input
	if _game_state.platform_rect.rect.end.x > _game_state.playing_area_size.x:
		_game_state.platform_rect.rect.position.x = _game_state.playing_area_size.x-_game_state.platform_rect.rect.size.x
	elif _game_state.platform_rect.rect.position.x < 0.0:
		_game_state.platform_rect.rect.position.x = 0.0



func _check_blocks_deadline() -> bool:
	for rect:ArcanoidRect in _game_state.blocks:
		if rect.rect.end.y > _game_state.blocks_deadline_height:
			return true
	
	return false


func _spawn_blocks_layer() -> void:
	for rect:ArcanoidRect in _game_state.blocks:
		rect.rect.position.y += _game_state.block_size.y + _game_state.block_rows_gap
	
	var spawned_columns : Array[int] = []
	var spawn_count : int = min(_game_state.blocks_spawn_count, _game_state.blocks_columns)
	var x_offset : float = (_game_state.playing_area_size.x - \\
			(_game_state.block_size.x+_game_state.blocks_columns_gap)*_game_state.blocks_columns)/2.0
	
	for i:int in spawn_count:
		var column : int = randi()%_game_state.blocks_columns
		while column in spawned_columns: column = randi()%_game_state.blocks_columns
		spawned_columns.append(column)
		var new_block := ArcanoidBlock.new(
			Rect2(Vector2(_game_state.block_size.x+_game_state.blocks_columns_gap, 0.0)*column + \\
				Vector2(x_offset, _game_state.top_row_gap), _game_state.block_size), 6)
		_game_state.blocks.append(new_block)


func _on_ball_platform_collision() -> void:
	if _game_state.new_blocks_spawning:
		_spawn_blocks_layer()
	
	if _check_blocks_deadline():
		_on_blocks_reached_deadline()
	_game_state.ball_velocity *= _game_state.speed_factor
	_game_state.platform_speed *= _game_state.speed_factor


func _on_ball_falled() -> void:
	_damage_reason = DamageReasons.BALL_FALLED
	if await _do_damage():
		return
	_game_state.state_machine.go_state(GameState.LAUNCHING_BALL_STATE)


func _on_blocks_reached_deadline() -> void:
	_damage_reason = DamageReasons.DEADLINE_REACHED
	if await _do_damage():
		return
	
	_game_state.blocks = []
	for i:int in _game_state.initial_block_rows:
		_spawn_blocks_layer()
	_game_state.state_machine.go_state(GameState.LAUNCHING_BALL_STATE)


# returns true if health expired after damage
func _do_damage() -> bool:
	_game_state.health -= 1
	if chosen_ability != null:
			chosen_ability.deactivate()
	_game_state.state_machine.go_state(GameState.WAITING_FOR_DAMAGE_STATE)
	await get_tree().create_timer(DAMAGE_TIME_AWATING).timeout
	if _game_state.health <= 0:
		_on_health_expired()
		return true
	return false


func _on_health_expired() -> void:
	_game_state.state_machine.go_state(GameState.GAME_OVER_STATE)
	(%Screens as TabContainer).current_tab = \\
		(%Screens as TabContainer).get_tab_idx_from_control(%GameOverScreen)
	(%Screens as Control).show()
	(%GameOverScreen as GameOverScreenUIApi).set_score(_game_state.score)


func _on_game_starging_ui_start_button_pressed(ability:GameAbilitiesNamespace.Types) -> void:
	(%Screens as Control).hide()
	match ability:
		GameAbilitiesNamespace.Types.SLOWTIME:
			chosen_ability = $SlowtimeAbility
		GameAbilitiesNamespace.Types.SHOW_BALL_TRAJECTORY:
			chosen_ability = $BallTrajectroryAbility
		GameAbilitiesNamespace.Types.PLATFORM_ACCELERATION:
			chosen_ability = $PlatformAccelerationAbility
		GameAbilitiesNamespace.Types.PLATFORM_EXTENSION:
			chosen_ability = $PlatformExtensionAbility
		GameAbilitiesNamespace.Types.MAGNETISM:
			chosen_ability = $MagnetismAbility
	
	_game_state.state_machine.go_state(GameState.LAUNCHING_BALL_STATE)


func _on_drawer_draw() -> void:
	if not chosen_ability:
		return
	
	(%Drawer as CanvasItem).draw_rect(_game_state.platform_rect.rect.grow_side(SIDE_RIGHT,
		-_game_state.platform_rect.rect.size.x*(1.0-chosen_ability.relative_balance)),
		_game_state.platform_color)
"

[sub_resource type="GDScript" id="GDScript_khgdo"]
resource_name = "slowtime_ability"
script/source = "extends Ability


@onready 
var _game_state: GameState = %GameState

@export_range(0.1, 1.0)
var slow_time_value : float = 0.3


func _on_activated() -> void:
	_active = true
	Engine.time_scale = slow_time_value


func _on_deactivated() -> void:
	_active = false
	Engine.time_scale = 1.0
"

[sub_resource type="GDScript" id="GDScript_jnwm8"]
resource_name = "ball_trajectory_ability"
script/source = "extends Ability

@onready 
var _game_state: GameState = %GameState


func _on_drawer_draw() -> void:
	if not _active:
		return
	
	if _game_state.state_machine.state != GameState.CONTROLLING_BALL_STATE:
		return
	
	(%Drawer as CanvasItem).draw_line(_game_state.ball_position, 
		_game_state.ball_position+_game_state.ball_velocity, 
		_game_state.ball_color, 1.0, true)
"

[sub_resource type="GDScript" id="GDScript_col8f"]
resource_name = "platform_acceleration_ability"
script/source = "extends Ability

@onready 
var _game_state: GameState = %GameState

@export_range(1.0, 5.0)
var acceleration_value : float = 1.1

func _on_activated() -> void:
	_active = true
	_game_state.platform_speed *= acceleration_value


func _on_deactivated() -> void:
	_active = false
	_game_state.platform_speed /= acceleration_value
"

[sub_resource type="GDScript" id="GDScript_1clpx"]
resource_name = "platform_extension_ability"
script/source = "extends Ability

@export_range(0.0, 1_000.0)
var extension_distance : float = 20.0

@onready
var _game_state: GameState = %GameState

func _on_activated() -> void:
	_game_state.platform_rect.rect = _game_state.platform_rect.rect.grow_individual(extension_distance, 0.0, extension_distance, 0.0)


func _on_deactivated() -> void:
	_game_state.platform_rect.rect = _game_state.platform_rect.rect.grow_individual(-extension_distance, 0.0, -extension_distance, 0.0)
"

[sub_resource type="GDScript" id="GDScript_6431r"]
resource_name = "magnetism_ability"
script/source = "extends Ability

@export_range(0.0, 100.0)
var magnetism_power : float = 10.0

@onready 
var _game_state: GameState = %GameState


func _process(delta: float) -> void:
	super(delta)
	if not _active:
		return
	
	var acceleration : Vector2 = \\
		(_game_state.platform_rect.rect.get_center() - _game_state.ball_position).normalized()*magnetism_power
	var speed : float = _game_state.ball_velocity.length()
	_game_state.ball_velocity = (_game_state.ball_velocity+acceleration).normalized()*speed
"

[sub_resource type="GDScript" id="GDScript_hy8dd"]
resource_name = "gui_handler"
script/source = "extends CanvasLayer


func _on_game_over_screen_main_menu_button_pressed() -> void:
	pass # Replace with function body.


func _on_game_over_screen_quit_game_button_pressed() -> void:
	get_tree().quit()


func _on_game_over_screen_restart_button_pressed() -> void:
	get_tree().reload_current_scene()
"

[sub_resource type="GDScript" id="GDScript_0skvr"]
resource_name = "speed_label"
script/source = "extends Label

@onready
var _game_state : GameState = %GameState

func _process(delta: float) -> void:
	text = \"Ball speed: %.0f\" % _game_state.ball_velocity.length()
"

[sub_resource type="GDScript" id="GDScript_fgexy"]
resource_name = "health_label"
script/source = "extends Label

@onready
var _game_state : GameState = %GameState

func _process(delta: float) -> void:
	text = \"Health: %d/%d\" % [_game_state.health, _game_state.maximum_health]
"

[sub_resource type="GDScript" id="GDScript_4yrex"]
resource_name = "score_label"
script/source = "extends Label

@onready
var _game_state : GameState = %GameState

func _process(delta: float) -> void:
	text = \"Score: %d\" % _game_state.score
"

[sub_resource type="Environment" id="Environment_a6df3"]
background_mode = 3
glow_enabled = true
glow_levels/1 = 5.99
glow_levels/2 = 2.71
glow_levels/3 = 2.22
glow_levels/5 = 0.0
glow_normalized = true
glow_intensity = 1.75
glow_strength = 0.64
glow_bloom = 0.39
glow_blend_mode = 0

[node name="ArcanoidGame" type="Node"]

[node name="Drawer" type="Node2D" parent="."]
unique_name_in_owner = true
script = SubResource("GDScript_vuba5")

[node name="GameController" type="Node" parent="."]
unique_name_in_owner = true
script = SubResource("GDScript_ypwq7")

[node name="SlowtimeAbility" type="Node" parent="GameController"]
script = SubResource("GDScript_khgdo")
time_capacity = 0.3
time_remains_recovery_scale = 0.25

[node name="BallTrajectroryAbility" type="Node" parent="GameController"]
script = SubResource("GDScript_jnwm8")
time_remains_recovery_scale = 0.25

[node name="PlatformAccelerationAbility" type="Node" parent="GameController"]
script = SubResource("GDScript_col8f")
acceleration_value = 2.0
time_remains_recovery_scale = 0.25

[node name="PlatformExtensionAbility" type="Node" parent="GameController"]
script = SubResource("GDScript_1clpx")

[node name="MagnetismAbility" type="Node" parent="GameController"]
script = SubResource("GDScript_6431r")
magnetism_power = 20.0

[node name="GameState" type="Node" parent="."]
unique_name_in_owner = true
script = ExtResource("3_6rb05")
speed_factor = 1.02
playing_area_size = Vector2(800, 600)
initial_ball_radius = 7.0
initial_ball_speed = 400.0
initial_platform_size = Vector2(80, 10)
initial_platform_speed = 400.0
platform_height = 10.0
block_size = Vector2(40, 20)
block_rows_gap = 1.0
blocks_columns_gap = 1.0
initial_block_spawn_amount = 2
initial_block_rows = 1
top_row_gap = 5.0

[node name="GUI" type="CanvasLayer" parent="."]
layer = 3
script = SubResource("GDScript_hy8dd")

[node name="Control" type="Control" parent="GUI"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
theme = ExtResource("2_665qb")

[node name="SpeedLabel" type="Label" parent="GUI/Control"]
layout_mode = 0
offset_right = 95.0
offset_bottom = 39.0
script = SubResource("GDScript_0skvr")

[node name="HealthLabel" type="Label" parent="GUI/Control"]
layout_mode = 1
anchors_preset = 1
anchor_left = 1.0
anchor_right = 1.0
offset_left = -40.0
offset_bottom = 23.0
grow_horizontal = 0
script = SubResource("GDScript_fgexy")

[node name="ScoreLabel" type="Label" parent="GUI/Control"]
layout_mode = 1
anchors_preset = 5
anchor_left = 0.5
anchor_right = 0.5
offset_left = -20.0
offset_right = 20.0
offset_bottom = 23.0
grow_horizontal = 2
script = SubResource("GDScript_4yrex")

[node name="Screens" type="TabContainer" parent="GUI/Control"]
unique_name_in_owner = true
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
current_tab = 0
tabs_visible = false

[node name="GameStartingUI" parent="GUI/Control/Screens" instance=ExtResource("3_ricfi")]
unique_name_in_owner = true
layout_mode = 2
metadata/_tab_index = 0

[node name="GameOverScreen" parent="GUI/Control/Screens" instance=ExtResource("4_47ygy")]
unique_name_in_owner = true
visible = false
layout_mode = 2
metadata/_tab_index = 1

[node name="WorldEnvironment" type="WorldEnvironment" parent="."]
environment = SubResource("Environment_a6df3")

[connection signal="draw" from="Drawer" to="GameController" method="_on_drawer_draw"]
[connection signal="draw" from="Drawer" to="GameController/BallTrajectroryAbility" method="_on_drawer_draw"]
[connection signal="start_button_pressed" from="GUI/Control/Screens/GameStartingUI" to="GameController" method="_on_game_starging_ui_start_button_pressed"]
[connection signal="main_menu_button_pressed" from="GUI/Control/Screens/GameOverScreen" to="GUI" method="_on_game_over_screen_main_menu_button_pressed"]
[connection signal="quit_game_button_pressed" from="GUI/Control/Screens/GameOverScreen" to="GUI" method="_on_game_over_screen_quit_game_button_pressed"]
[connection signal="restart_button_pressed" from="GUI/Control/Screens/GameOverScreen" to="GUI" method="_on_game_over_screen_restart_button_pressed"]
